{"version":3,"sources":["../../src/utils/webpack.config.js"],"names":["require","isCI","crypto","fs","path","dotenv","CoreJSResolver","CacheFolderResolver","store","actions","getPublicPath","debug","report","apiRunnerNode","BabelConfigItemsCacheInvalidatorPlugin","FRAMEWORK_BUNDLES","module","exports","program","directory","suppliedStage","port","parentSpan","fastRefreshPlugin","modulesThatUseGatsby","directoryPath","process","env","GATSBY_BUILD_STAGE","stage","rules","loaders","plugins","assetPrefix","pathPrefix","getState","config","publicPath","processEnv","defaultNodeEnv","nodeEnv","NODE_ENV","configEnv","GATSBY_ACTIVE_ENV","envFile","join","cwd","parsed","parse","readFileSync","encoding","err","code","error","envObject","Object","keys","reduce","acc","key","JSON","stringify","gatsbyVarObject","match","PUBLIC_DIR","BUILD_STAGE","CYPRESS_SUPPORT","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","GATSBY_SOCKET_IO_DEFAULT_TRANSPORT","mergedEnvVars","assign","getHmrPath","hmrBasePath","hmrSuffix","GATSBY_WEBPACK_PUBLICPATH","pubPath","substr","getOutput","filename","pathinfo","devtoolModuleFilenameTemplate","info","resolve","absoluteResourcePath","replace","crossOriginLoading","libraryTarget","chunkFilename","ROUTES_DIRECTORY","Error","getEntry","commons","polyfill","main","GATSBY_EXPERIMENTAL_DEV_SSR","entries","create","componentPath","componentChunkName","components","app","getPlugins","configPlugins","moment","define","__BASE_PATH__","prefixPaths","__PATH_PREFIX__","__ASSET_PREFIX__","BROWSER_ESM_ONLY","virtualModules","concat","fastRefresh","ForceCssHMRForEdgeCases","hotModuleReplacement","noEmitOnErrors","eslintGraphqlSchemaReload","StaticQueryMapper","filter","Boolean","push","extractText","extractStats","isCustomEslint","schema","eslint","eslintRequired","getDevtool","getMode","getModule","configRules","test","byDependency","esm","fullySpecified","descriptionData","type","js","yaml","fonts","images","media","miscAssets","use","loader","dependencies","oneOf","cssModules","css","null","getPackageRoot","pkg","dirname","getResolve","extensions","alias","gatsby$","$virtual","target","profile","getResolveLoader","root","userLoaderDirectoryPath","statSync","isDirectory","modules","__dirname","context","entry","output","devtool","performance","hints","mode","resolveLoader","major","minor","version","split","isCssModule","optimization","splitChunks","chunks","cacheGroups","default","defaultVendors","framework","name","RegExp","priority","enforce","styles","minimize","componentsCount","size","lib","identifier","hash","createHash","libIdent","update","digest","substring","minChunks","reuseExistingChunk","Math","max","shared","chunk","maxAsyncRequests","Infinity","maxInitialRequests","minSize","runtimeChunk","minimizer","noUglify","minifyJs","terserOptions","keep_classnames","keep_fnames","minifyCss","shouldMarkPackagesAsExternal","shouldTrackBuiltins","externalsPresets","node","externals","userExternalList","checkItem","item","request","callback","resolver","dependencyType","some","newRequest","builtinModulesToTrack","builtinsExternalsDictionary","builtinModules","builtinModule","includes","unshift","GATSBY_EXPERIMENTAL_DEV_WEBPACK_CACHE","cacheLocation","cacheConfig","buildDependencies","__filename","flattenedPlugins","plugin","nodeAPIs","map","cache","dispatch","replaceWebpackConfig","getConfig","webpack","fastRefreshIncludes","babelLoaderLoc","rule","ruleLoaders","Array","isArray","useEntry","hasBabelLoader","includeRegex","modulePath","queryParamStartIndex","indexOf","re","options","include"],"mappings":";;AAcA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAzBAA,OAAO,CAAE,kBAAF,CAAP;;AAEA,MAAM;AAAEC,EAAAA;AAAF,IAAWD,OAAO,CAAE,mBAAF,CAAxB;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAE,QAAF,CAAtB;;AACA,MAAMG,EAAE,GAAGH,OAAO,CAAE,UAAF,CAAlB;;AACA,MAAMI,IAAI,GAAGJ,OAAO,CAAE,MAAF,CAApB;;AACA,MAAMK,MAAM,GAAGL,OAAO,CAAE,QAAF,CAAtB;;AACA,MAAM;AAAEM,EAAAA;AAAF,IAAqBN,OAAO,CAAE,2BAAF,CAAlC;;AACA,MAAM;AAAEO,EAAAA;AAAF,IAA0BP,OAAO,CAAE,iCAAF,CAAvC;;AACA,MAAM;AAAEQ,EAAAA;AAAF,IAAYR,OAAO,CAAE,UAAF,CAAzB;;AACA,MAAM;AAAES,EAAAA;AAAF,IAAcT,OAAO,CAAE,kBAAF,CAA3B;;AACA,MAAM;AAAEU,EAAAA;AAAF,IAAoBV,OAAO,CAAE,mBAAF,CAAjC;;AACA,MAAMW,KAAK,GAAGX,OAAO,CAAE,OAAF,CAAP,CAAkB,uBAAlB,CAAd;;AACA,MAAMY,MAAM,GAAGZ,OAAO,CAAE,yBAAF,CAAtB;;AAGA,MAAMa,aAAa,GAAGb,OAAO,CAAE,mBAAF,CAA7B;;AAUA,MAAM;AAAEc,EAAAA;AAAF,IAA6Cd,OAAO,CAAE,gBAAF,CAA1D;;AAEA,MAAMe,iBAAiB,GAAG,CAAE,OAAF,EAAW,WAAX,EAAwB,WAAxB,EAAqC,YAArC,CAA1B,C,CAEA;AACA;AACA;AACA;AACA;;AAEAC,MAAM,CAACC,OAAP,GAAiB,OACfC,OADe,EAEfC,SAFe,EAGfC,aAHe,EAIfC,IAJe,EAKf;AAAEC,EAAAA;AAAF,IAAiB,EALF,KAMZ;AACH,MAAIC,iBAAJ;AACA,QAAMC,oBAAoB,GAAG,MAAM,4CAAnC;AACA,QAAMC,aAAa,GAAG,wBAAaN,SAAb,CAAtB,CAHG,CAKH;AACA;;AACAO,EAAAA,OAAO,CAACC,GAAR,CAAYC,kBAAZ,GACER,aAAa,KAAM,WAAnB,GAAiC,YAAjC,GAA+CA,aADjD,CAPG,CAUH;AACA;;AACA,QAAMS,KAAK,GAAGT,aAAd;AACA,QAAM;AAAEU,IAAAA,KAAF;AAASC,IAAAA,OAAT;AAAkBC,IAAAA;AAAlB,MAA8B,sCAClCZ,aAAa,KAAM,WAAnB,GAAiC,YAAjC,GAA+CS,KADb,EAElCX,OAFkC,CAApC;AAKA,QAAM;AAAEe,IAAAA,WAAF;AAAeC,IAAAA;AAAf,MAA8B1B,KAAK,CAAC2B,QAAN,GAAiBC,MAArD;AAEA,QAAMC,UAAU,GAAG3B,aAAa,CAAC;AAAEuB,IAAAA,WAAF;AAAeC,IAAAA,UAAf;AAA2B,OAAGhB;AAA9B,GAAD,CAAhC;;AAEA,WAASoB,UAAT,CAAoBT,KAApB,EAA2BU,cAA3B,EAA2C;AACzC5B,IAAAA,KAAK,CAAE,qBAAoBkB,KAAM,GAA5B,CAAL,CADyC,CAEzC;AACA;;AACA,UAAMW,OAAO,GAAGd,OAAO,CAACC,GAAR,CAAYc,QAAZ,IAAyB,GAAEF,cAAe,EAA1D,CAJyC,CAKzC;AACA;;AACA,UAAMG,SAAS,GAAGhB,OAAO,CAACC,GAAR,CAAYgB,iBAAZ,IAAiCH,OAAnD;AACA,UAAMI,OAAO,GAAGxC,IAAI,CAACyC,IAAL,CAAUnB,OAAO,CAACoB,GAAR,EAAV,EAA0B,UAASJ,SAAU,EAA7C,CAAhB;AACA,QAAIK,MAAM,GAAG,EAAb;;AACA,QAAI;AACFA,MAAAA,MAAM,GAAG1C,MAAM,CAAC2C,KAAP,CAAa7C,EAAE,CAAC8C,YAAH,CAAgBL,OAAhB,EAAyB;AAAEM,QAAAA,QAAQ,EAAG;AAAb,OAAzB,CAAb,CAAT;AACD,KAFD,CAEE,OAAOC,GAAP,EAAY;AACZ,UAAIA,GAAG,CAACC,IAAJ,KAAc,QAAlB,EAA2B;AACzBxC,QAAAA,MAAM,CAACyC,KAAP,CACG,iDAAgDT,OAAQ,GAD3D,EAEEO,GAFF;AAID;AACF;;AAED,UAAMG,SAAS,GAAGC,MAAM,CAACC,IAAP,CAAYT,MAAZ,EAAoBU,MAApB,CAA2B,CAACC,GAAD,EAAMC,GAAN,KAAc;AACzDD,MAAAA,GAAG,CAACC,GAAD,CAAH,GAAWC,IAAI,CAACC,SAAL,CAAed,MAAM,CAACY,GAAD,CAArB,CAAX;AACA,aAAOD,GAAP;AACD,KAHiB,EAGf,EAHe,CAAlB;AAKA,UAAMI,eAAe,GAAGP,MAAM,CAACC,IAAP,CAAY9B,OAAO,CAACC,GAApB,EAAyB8B,MAAzB,CAAgC,CAACC,GAAD,EAAMC,GAAN,KAAc;AACpE,UAAIA,GAAG,CAACI,KAAJ,CAAU,UAAV,CAAJ,EAA2B;AACzBL,QAAAA,GAAG,CAACC,GAAD,CAAH,GAAWC,IAAI,CAACC,SAAL,CAAenC,OAAO,CAACC,GAAR,CAAYgC,GAAZ,CAAf,CAAX;AACD;;AACD,aAAOD,GAAP;AACD,KALuB,EAKrB,EALqB,CAAxB,CA1ByC,CAiCzC;;AACAJ,IAAAA,SAAS,CAACb,QAAV,GAAqBmB,IAAI,CAACC,SAAL,CAAerB,OAAf,CAArB;AACAc,IAAAA,SAAS,CAACU,UAAV,GAAuBJ,IAAI,CAACC,SAAL,CAAgB,GAAEnC,OAAO,CAACoB,GAAR,EAAc,SAAhC,CAAvB;AACAQ,IAAAA,SAAS,CAACW,WAAV,GAAwBL,IAAI,CAACC,SAAL,CACtBhC,KAAK,KAAM,WAAX,GAAyB,YAAzB,GAAuCA,KADjB,CAAxB;AAGAyB,IAAAA,SAAS,CAACY,eAAV,GAA4BN,IAAI,CAACC,SAAL,CAAenC,OAAO,CAACC,GAAR,CAAYuC,eAA3B,CAA5B;AACAZ,IAAAA,SAAS,CAACa,mCAAV,GAAgDP,IAAI,CAACC,SAAL,CAC9C,CAAC,CAACnC,OAAO,CAACC,GAAR,CAAYwC,mCADgC,CAAhD;;AAIA,QAAItC,KAAK,KAAM,SAAf,EAAyB;AACvByB,MAAAA,SAAS,CAACc,kCAAV,GAA+CR,IAAI,CAACC,SAAL,CAC7CnC,OAAO,CAACC,GAAR,CAAYyC,kCAAZ,IAAmD,WADN,CAA/C;AAGD;;AAED,UAAMC,aAAa,GAAGd,MAAM,CAACe,MAAP,CAAchB,SAAd,EAAyBQ,eAAzB,CAAtB;AAEA,WAAOP,MAAM,CAACC,IAAP,CAAYa,aAAZ,EAA2BZ,MAA3B,CACL,CAACC,GAAD,EAAMC,GAAN,KAAc;AACZD,MAAAA,GAAG,CAAE,eAAcC,GAAI,EAApB,CAAH,GAA4BU,aAAa,CAACV,GAAD,CAAzC;AACA,aAAOD,GAAP;AACD,KAJI,EAKL;AACE,qBAAgB;AADlB,KALK,CAAP;AASD;;AAED,WAASa,UAAT,GAAsB;AACpB;AACA,QAAIC,WAAW,GAAI,GAAnB;AACA,UAAMC,SAAS,GAAI,yCAAnB;;AAEA,QAAI/C,OAAO,CAACC,GAAR,CAAY+C,yBAAhB,EAA2C;AACzC,YAAMC,OAAO,GAAGjD,OAAO,CAACC,GAAR,CAAY+C,yBAA5B;;AACA,UAAIC,OAAO,CAACC,MAAR,CAAe,CAAC,CAAhB,MAAwB,GAA5B,EAAgC;AAC9BJ,QAAAA,WAAW,GAAGG,OAAd;AACD,OAFD,MAEO;AACLH,QAAAA,WAAW,GAAG,6BAAkBG,OAAlB,CAAd;AACD;AACF;;AAED,WAAOH,WAAW,GAAGC,SAArB;AACD;;AAED9D,EAAAA,KAAK,CAAE,qCAAoCkB,KAAM,GAA5C,CAAL;;AACA,WAASgD,SAAT,GAAqB;AACnB,YAAQhD,KAAR;AACE,WAAM,SAAN;AACE,eAAO;AACLzB,UAAAA,IAAI,EAAEe,SADD;AAEL2D,UAAAA,QAAQ,EAAG,WAFN;AAGL;AACAC,UAAAA,QAAQ,EAAE,IAJL;AAKL;AACA1C,UAAAA,UAAU,EAAEX,OAAO,CAACC,GAAR,CAAY+C,yBAAZ,IAA0C,GANjD;AAOLM,UAAAA,6BAA6B,EAAEC,IAAI,IACjC7E,IAAI,CAAC8E,OAAL,CAAaD,IAAI,CAACE,oBAAlB,EAAwCC,OAAxC,CAAgD,KAAhD,EAAwD,GAAxD,CARG;AASL;AACA;AACAC,UAAAA,kBAAkB,EAAG;AAXhB,SAAP;;AAaF,WAAM,YAAN;AACA,WAAM,cAAN;AACE;AACA;AACA,eAAO;AACLjF,UAAAA,IAAI,EAAEqB,aAAa,CAAE,QAAF,CADd;AAELqD,UAAAA,QAAQ,EAAG,gBAFN;AAGLQ,UAAAA,aAAa,EAAG,UAHX;AAILjD,UAAAA,UAAU,EAAE,6BAAkBA,UAAlB;AAJP,SAAP;;AAMF,WAAM,kBAAN;AACE,eAAO;AACLyC,UAAAA,QAAQ,EAAG,yBADN;AAELS,UAAAA,aAAa,EAAG,yBAFX;AAGLnF,UAAAA,IAAI,EAAEqB,aAAa,CAAE,QAAF,CAHd;AAILY,UAAAA,UAAU,EAAE,6BAAkBA,UAAlB;AAJP,SAAP;;AAMF,WAAM,WAAN;AAAkB;AAChB,iBAAO;AACLjC,YAAAA,IAAI,EAAEqB,aAAa,CAAC+D,2BAAD,CADd;AAELV,YAAAA,QAAQ,EAAG,WAFN;AAGLQ,YAAAA,aAAa,EAAG;AAHX,WAAP;AAKD;;AACD;AACE,cAAM,IAAIG,KAAJ,CAAW,uBAAsB5D,KAAM,iBAAvC,CAAN;AAxCJ;AA0CD;;AAED,WAAS6D,QAAT,GAAoB;AAClB,YAAQ7D,KAAR;AACE,WAAM,SAAN;AACE,eAAO,uCAAoBV,SAApB,IACH;AACEwE,UAAAA,OAAO,EAAE,CAAClE,aAAa,CAAE,YAAF,CAAd;AADX,SADG,GAIH;AACEmE,UAAAA,QAAQ,EAAEnE,aAAa,CAAE,uBAAF,CADzB;AAEEkE,UAAAA,OAAO,EAAE,CAAClE,aAAa,CAAE,YAAF,CAAd;AAFX,SAJJ;;AAQF,WAAM,cAAN;AACE,eAAO;AACLoE,UAAAA,IAAI,EAAEnE,OAAO,CAACC,GAAR,CAAYmE,2BAAZ,GACFrE,aAAa,CAAE,iCAAF,CADX,GAEFA,aAAa,CAAE,6BAAF;AAHZ,SAAP;;AAKF,WAAM,WAAN;AAAkB;AAChB,gBAAMsE,OAAO,GAAGxC,MAAM,CAACyC,MAAP,CAAc,IAAd,CAAhB;;AACA,eAAK,MAAM,GAAG;AAAEC,YAAAA,aAAF;AAAiBC,YAAAA;AAAjB,WAAH,CAAX,IAAwD1F,KAAK,CAAC2B,QAAN,GACrDgE,UADH,EACe;AACbJ,YAAAA,OAAO,CAACG,kBAAD,CAAP,GAA8BD,aAA9B;AACD;;AAED,iBAAOF,OAAP;AACD;;AACD,WAAM,YAAN;AACE,eAAO;AACLF,UAAAA,IAAI,EAAEpE,aAAa,CAAE,qBAAF;AADd,SAAP;;AAGF,WAAM,kBAAN;AACE,eAAO,uCAAoBN,SAApB,IACH;AACEiF,UAAAA,GAAG,EAAE3E,aAAa,CAAE,uBAAF;AADpB,SADG,GAIH;AACEmE,UAAAA,QAAQ,EAAEnE,aAAa,CAAE,uBAAF,CADzB;AAEE2E,UAAAA,GAAG,EAAE3E,aAAa,CAAE,uBAAF;AAFpB,SAJJ;;AAQF;AACE,cAAM,IAAIgE,KAAJ,CAAW,uBAAsB5D,KAAM,iBAAvC,CAAN;AAvCJ;AAyCD;;AAED,WAASwE,UAAT,GAAsB;AACpB,QAAIC,aAAa,GAAG,CAClBtE,OAAO,CAACuE,MAAR,EADkB,EAGlB;AACA;AACAvE,IAAAA,OAAO,CAACwE,MAAR,CAAe,EACb,GAAGlE,UAAU,CAACT,KAAD,EAAS,aAAT,CADA;AAEb4E,MAAAA,aAAa,EAAE7C,IAAI,CAACC,SAAL,CAAe3C,OAAO,CAACwF,WAAR,GAAsBxE,UAAtB,GAAoC,EAAnD,CAFF;AAGbyE,MAAAA,eAAe,EAAE/C,IAAI,CAACC,SAAL,CAAe3C,OAAO,CAACwF,WAAR,GAAsBrE,UAAtB,GAAoC,EAAnD,CAHJ;AAIbuE,MAAAA,gBAAgB,EAAEhD,IAAI,CAACC,SAAL,CAChB3C,OAAO,CAACwF,WAAR,GAAsBzE,WAAtB,GAAqC,EADrB,CAJL;AAOb;AACA4E,MAAAA,gBAAgB,EAAEjD,IAAI,CAACC,SAAL,CAAe,uCAAoB1C,SAApB,CAAf;AARL,KAAf,CALkB,EAgBlBa,OAAO,CAAC8E,cAAR,EAhBkB,EAiBlB,IAAIhG,sCAAJ,EAjBkB,CAApB;;AAoBA,YAAQe,KAAR;AACE,WAAM,SAAN;AAAgB;AACdyE,UAAAA,aAAa,GAAGA,aAAa,CAC1BS,MADa,CACN,CACLxF,iBAAiB,GAAGS,OAAO,CAACgF,WAAR,CAAoB;AAAExF,YAAAA;AAAF,WAApB,CADf,EAEN,IAAIyF,gDAAJ,EAFM,EAGNjF,OAAO,CAACkF,oBAAR,EAHM,EAINlF,OAAO,CAACmF,cAAR,EAJM,EAKNnF,OAAO,CAACoF,yBAAR,EALM,EAMN,IAAIC,oCAAJ,CAAsB7G,KAAtB,CANM,CADM,EASb8G,MATa,CASNC,OATM,CAAhB;AAWAjB,UAAAA,aAAa,CAACkB,IAAd,CACExF,OAAO,CAACyF,WAAR,CAAoB;AAClB3C,YAAAA,QAAQ,EAAG,YADO;AAElBS,YAAAA,aAAa,EAAG;AAFE,WAApB,CADF;;AAOA,cAAI7D,OAAO,CAACC,GAAR,CAAYmE,2BAAhB,EAA6C;AAC3CQ,YAAAA,aAAa,CAACkB,IAAd,CAAmBxF,OAAO,CAAC0F,YAAR,EAAnB;AACD;;AAED,gBAAMC,cAAc,GAAG,6CAAezG,OAAO,CAACC,SAAvB,CAAvB,CAvBc,CAwBd;;AACA,gBAAM;AAAEyG,YAAAA;AAAF,cAAapH,KAAK,CAAC2B,QAAN,EAAnB,CAzBc,CA2Bd;;AACA,cAAI,CAACwF,cAAL,EAAqB;AACnBrB,YAAAA,aAAa,CAACkB,IAAd,CAAmBxF,OAAO,CAAC6F,MAAR,CAAeD,MAAf,CAAnB;AACD,WA9Ba,CAgCd;;;AACA,cAAID,cAAJ,EAAoB;AAClBrB,YAAAA,aAAa,CAACkB,IAAd,CAAmBxF,OAAO,CAAC8F,cAAR,EAAnB;AACD;;AAED;AACD;;AACD,WAAM,kBAAN;AAAyB;AACvBxB,UAAAA,aAAa,GAAGA,aAAa,CAACS,MAAd,CAAqB,CACnC/E,OAAO,CAACyF,WAAR,CAAoB;AAClB3C,YAAAA,QAAQ,EAAG,0BADO;AAElBS,YAAAA,aAAa,EAAG;AAFE,WAApB,CADmC,EAKnC;AACA;AACAvD,UAAAA,OAAO,CAAC0F,YAAR,EAPmC,EAQnC,IAAIL,oCAAJ,CAAsB7G,KAAtB,CARmC,CAArB,CAAhB;AAUA;AACD;AApDH;;AAuDA,WAAO8F,aAAP;AACD;;AAED,WAASyB,UAAT,GAAsB;AACpB,YAAQlG,KAAR;AACE,WAAM,SAAN;AACE,eAAQ,8BAAR;AACF;AACA;;AACA,WAAM,cAAN;AACA,WAAM,YAAN;AACA,WAAM,WAAN;AACA,WAAM,kBAAN;AACE,eAAQ,YAAR;;AACF;AACE,eAAO,KAAP;AAXJ;AAaD;;AAED,WAASmG,OAAT,GAAmB;AACjB,YAAQnG,KAAR;AACE,WAAM,SAAN;AACA,WAAM,cAAN;AACE,eAAQ,aAAR;;AACF,WAAM,kBAAN;AACA,WAAM,YAAN;AACE,eAAQ,YAAR;;AACF;AACE,eAAQ,YAAR;AARJ;AAUD;;AAED,WAASoG,SAAT,GAAqB;AACnB;AACA;AACA,QAAIC,WAAW,GAAG,CAChB;AACA;AACA;AACA;AACEC,MAAAA,IAAI,EAAE,SADR;AAEEjD,MAAAA,OAAO,EAAE;AACPkD,QAAAA,YAAY,EAAE;AACZC,UAAAA,GAAG,EAAE;AACHC,YAAAA,cAAc,EAAE;AADb;AADO;AADP;AAFX,KAJgB,EAchB;AACEH,MAAAA,IAAI,EAAE,QADR;AAEEI,MAAAA,eAAe,EAAE;AACfC,QAAAA,IAAI,EAAG;AADQ,OAFnB;AAKEtD,MAAAA,OAAO,EAAE;AACPkD,QAAAA,YAAY,EAAE;AACZC,UAAAA,GAAG,EAAE;AACHC,YAAAA,cAAc,EAAE;AADb;AADO;AADP;AALX,KAdgB,EA2BhBxG,KAAK,CAAC2G,EAAN,CAAS;AACPjH,MAAAA;AADO,KAAT,CA3BgB,EA8BhBM,KAAK,CAAC4G,IAAN,EA9BgB,EA+BhB5G,KAAK,CAAC6G,KAAN,EA/BgB,EAgChB7G,KAAK,CAAC8G,MAAN,EAhCgB,EAiChB9G,KAAK,CAAC+G,KAAN,EAjCgB,EAkChB/G,KAAK,CAACgH,UAAN,EAlCgB,EAoChB;AACA;AACA;AACA;AACA;AACEX,MAAAA,IAAI,EAAEnI,OAAO,CAACkF,OAAR,CAAiB,iCAAjB,CADR;AAEEsD,MAAAA,IAAI,EAAG,iBAFT;AAGEO,MAAAA,GAAG,EAAE,CAAC;AACJC,QAAAA,MAAM,EAAEhJ,OAAO,CAACkF,OAAR,CAAiB,8CAAjB;AADJ,OAAD;AAHP,KAxCgB,CAAlB,CAHmB,CAoDnB;AACA;;AACA,QAAIrD,KAAK,KAAM,kBAAf,EAAkC;AAChCqG,MAAAA,WAAW,CAACV,IAAZ,CACE1F,KAAK,CAACmH,YAAN,CAAmB;AACjBzH,QAAAA;AADiB,OAAnB,CADF;AAKD;;AAED,YAAQK,KAAR;AACE,WAAM,SAAN;AAAgB;AACdqG,UAAAA,WAAW,GAAGA,WAAW,CAACnB,MAAZ,CAAmB,CAC/B;AACEmC,YAAAA,KAAK,EAAE,CAACpH,KAAK,CAACqH,UAAN,EAAD,EAAqBrH,KAAK,CAACsH,GAAN,EAArB;AADT,WAD+B,CAAnB,CAAd;AAMA;AACD;;AACD,WAAM,YAAN;AACA,WAAM,cAAN;AACA,WAAM,WAAN;AACE;AACA;AACA;AAEA;AACAlB,QAAAA,WAAW,GAAGA,WAAW,CAACnB,MAAZ,CAAmB,CAC/B;AACEmC,UAAAA,KAAK,EAAE,CACLpH,KAAK,CAACqH,UAAN,EADK,EAEL,EACE,GAAGrH,KAAK,CAACsH,GAAN,EADL;AAEEL,YAAAA,GAAG,EAAE,CAAChH,OAAO,CAACsH,IAAR,EAAD;AAFP,WAFK;AADT,SAD+B,CAAnB,CAAd;AAWA;;AAEF,WAAM,kBAAN;AACE;AACA;AACA;AACA;AACA;AACA;AACAnB,QAAAA,WAAW,GAAGA,WAAW,CAACnB,MAAZ,CAAmB,CAC/B;AACEmC,UAAAA,KAAK,EAAE,CAACpH,KAAK,CAACqH,UAAN,EAAD,EAAqBrH,KAAK,CAACsH,GAAN,EAArB;AADT,SAD+B,CAAnB,CAAd;AAMA;AA5CJ;;AA+CA,WAAO;AAAEtH,MAAAA,KAAK,EAAEoG;AAAT,KAAP;AACD;;AAED,WAASoB,cAAT,CAAwBC,GAAxB,EAA6B;AAC3B,WAAOnJ,IAAI,CAACoJ,OAAL,CAAaxJ,OAAO,CAACkF,OAAR,CAAiB,GAAEqE,GAAI,eAAvB,CAAb,CAAP;AACD;;AAED,WAASE,UAAT,CAAoB5H,KAApB,EAA2B;AACzB,UAAM;AAAEX,MAAAA;AAAF,QAAcV,KAAK,CAAC2B,QAAN,EAApB;AACA,UAAM+C,OAAO,GAAG;AACd;AACA;AACAwE,MAAAA,UAAU,EAAE,CAAC,GAAGxI,OAAO,CAACwI,UAAZ,CAHE;AAIdC,MAAAA,KAAK,EAAE;AACLC,QAAAA,OAAO,EAAEnI,aAAa,CAACrB,IAAI,CAACyC,IAAL,CAAW,QAAX,EAAqB,yBAArB,CAAD,CADjB;AAEL;AACA;AACA;AACA,0BAAkByG,cAAc,CAAE,gBAAF,CAL3B;AAML,yBAAiBA,cAAc,CAAE,wBAAF,CAN1B;AAOL,mCAA2B7H,aAAa,CACrC,mCADqC,CAPnC;AAUL,gDAAwC6H,cAAc,CACnD,sCADmD,CAVjD;AAaL,4BAAoBA,cAAc,CAAE,kBAAF,CAb7B;AAcL,kCAA0BA,cAAc,CACrC,kCADqC,CAdnC;AAiBLO,QAAAA,QAAQ,EAAE,kEAAiC,UAAjC;AAjBL,OAJO;AAuBd7H,MAAAA,OAAO,EAAE,CACP,IAAI1B,cAAJ,EADO,EAEP,IAAIC,mBAAJ,CAAwBH,IAAI,CAACyC,IAAL,CAAU3B,OAAO,CAACC,SAAlB,EAA8B,QAA9B,CAAxB,CAFO;AAvBK,KAAhB;AA6BA,UAAM2I,MAAM,GACVjI,KAAK,KAAM,YAAX,IACAA,KAAK,KAAM,cADX,IAEAA,KAAK,KAAM,WAFX,GAGK,MAHL,GAIK,KALP;;AAMA,QAAIiI,MAAM,KAAM,KAAhB,EAAsB;AACpB5E,MAAAA,OAAO,CAACyE,KAAR,CAAe,eAAf,IAAiCvJ,IAAI,CAACyC,IAAL,CAC/ByG,cAAc,CAAE,wBAAF,CADiB,EAE9B,IAF8B,CAAjC;AAID;;AAED,QAAIzH,KAAK,KAAM,kBAAX,IAAgCX,OAAO,CAAC6I,OAA5C,EAAqD;AACnD7E,MAAAA,OAAO,CAACyE,KAAR,CAAe,YAAf,IAA+B,qBAA/B;AACAzE,MAAAA,OAAO,CAACyE,KAAR,CAAe,mBAAf,IAAsC,6BAAtC;AACD,KA/CwB,CAiDzB;AACA;AACA;AACA;AACA;;;AACAzE,IAAAA,OAAO,CAACyE,KAAR,CAAe,OAAf,IAAyBL,cAAc,CAAE,OAAF,CAAvC;AACApE,IAAAA,OAAO,CAACyE,KAAR,CAAe,WAAf,IAA6BL,cAAc,CAAE,WAAF,CAA3C;AAEA,WAAOpE,OAAP;AACD;;AAED,WAAS8E,gBAAT,GAA4B;AAC1B,UAAMC,IAAI,GAAG,CAAC7J,IAAI,CAAC8E,OAAL,CAAa/D,SAAb,EAAyB,cAAzB,CAAD,CAAb;AAEA,UAAM+I,uBAAuB,GAAG9J,IAAI,CAAC8E,OAAL,CAAa/D,SAAb,EAAyB,SAAzB,CAAhC;;AAEA,QAAI;AACF,UAAIhB,EAAE,CAACgK,QAAH,CAAYD,uBAAZ,EAAqCE,WAArC,EAAJ,EAAwD;AACtDH,QAAAA,IAAI,CAACzC,IAAL,CAAU0C,uBAAV;AACD;AACF,KAJD,CAIE,OAAO/G,GAAP,EAAY;AACZxC,MAAAA,KAAK,CAAE,wCAAF,EAA2CwC,GAA3C,CAAL;AACD;;AAED,WAAO;AACLkH,MAAAA,OAAO,EAAE,CAAC,GAAGJ,IAAJ,EAAU7J,IAAI,CAACyC,IAAL,CAAUyH,SAAV,EAAsB,YAAtB,CAAV,EAA+C,cAA/C;AADJ,KAAP;AAGD;;AAED,QAAMlI,MAAM,GAAG;AACb;AACAmI,IAAAA,OAAO,EAAEpJ,SAFI;AAGbqJ,IAAAA,KAAK,EAAE9E,QAAQ,EAHF;AAIb+E,IAAAA,MAAM,EAAE5F,SAAS,EAJJ;AAMb7D,IAAAA,MAAM,EAAEiH,SAAS,EANJ;AAObjG,IAAAA,OAAO,EAAEqE,UAAU,EAPN;AASbqE,IAAAA,OAAO,EAAE3C,UAAU,EATN;AAUb;AACA;AACA4C,IAAAA,WAAW,EAAE;AACXC,MAAAA,KAAK,EAAE;AADI,KAZA;AAebC,IAAAA,IAAI,EAAE7C,OAAO,EAfA;AAiBb8C,IAAAA,aAAa,EAAEd,gBAAgB,EAjBlB;AAkBb9E,IAAAA,OAAO,EAAEuE,UAAU,CAAC5H,KAAD;AAlBN,GAAf;;AAqBA,MACEA,KAAK,KAAM,YAAX,IACAA,KAAK,KAAM,cADX,IAEAA,KAAK,KAAM,WAHb,EAIE;AACA,UAAM,CAACkJ,KAAD,EAAQC,KAAR,IAAiBtJ,OAAO,CAACuJ,OAAR,CAAgB7F,OAAhB,CAAyB,GAAzB,EAA8B,EAA9B,EAAiC8F,KAAjC,CAAwC,GAAxC,CAAvB;AACA9I,IAAAA,MAAM,CAAC0H,MAAP,GAAiB,WAAjB;AACD,GAPD,MAOO;AACL1H,IAAAA,MAAM,CAAC0H,MAAP,GAAgB,CAAE,KAAF,EAAS,KAAT,CAAhB;AACD;;AAED,QAAMqB,WAAW,GAAGnK,MAAM,IAAIA,MAAM,CAACwH,IAAP,KAAiB,kBAA/C;;AAEA,MAAI3G,KAAK,KAAM,SAAf,EAAyB;AACvBO,IAAAA,MAAM,CAACgJ,YAAP,GAAsB;AACpBC,MAAAA,WAAW,EAAE;AACXC,QAAAA,MAAM,EAAG,KADE;AAEXC,QAAAA,WAAW,EAAE;AACXC,UAAAA,OAAO,EAAE,KADE;AAEXC,UAAAA,cAAc,EAAE,KAFL;AAGXC,UAAAA,SAAS,EAAE;AACTJ,YAAAA,MAAM,EAAG,KADA;AAETK,YAAAA,IAAI,EAAG,WAFE;AAGT;AACAxD,YAAAA,IAAI,EAAE,IAAIyD,MAAJ,CACH,iDAAgD7K,iBAAiB,CAAC8B,IAAlB,CAC9C,GAD8C,CAE/C,UAHE,CAJG;AASTgJ,YAAAA,QAAQ,EAAE,EATD;AAUT;AACAC,YAAAA,OAAO,EAAE;AAXA,WAHA;AAgBX;AACA;AACAC,UAAAA,MAAM,EAAE;AACN5D,YAAAA,IAAI,CAACnH,MAAD,EAAS;AACX,qBAAOmK,WAAW,CAACnK,MAAD,CAAlB;AACD,aAHK;;AAKN2K,YAAAA,IAAI,EAAG,SALD;AAMNE,YAAAA,QAAQ,EAAE,EANJ;AAONC,YAAAA,OAAO,EAAE;AAPH;AAlBG;AAFF,OADO;AAgCpBE,MAAAA,QAAQ,EAAE;AAhCU,KAAtB;AAkCD;;AAED,MAAInK,KAAK,KAAM,YAAf,EAA4B;AAC1BO,IAAAA,MAAM,CAACgJ,YAAP,GAAsB;AACpBY,MAAAA,QAAQ,EAAE;AADU,KAAtB;AAGD;;AAED,MAAInK,KAAK,KAAM,kBAAf,EAAkC;AAChC,UAAMoK,eAAe,GAAGzL,KAAK,CAAC2B,QAAN,GAAiBgE,UAAjB,CAA4B+F,IAApD;AAEA,UAAMb,WAAW,GAAG;AAClBC,MAAAA,MAAM,EAAG,KADS;AAElBC,MAAAA,WAAW,EAAE;AACXC,QAAAA,OAAO,EAAE,KADE;AAEXC,QAAAA,cAAc,EAAE,KAFL;AAGXC,QAAAA,SAAS,EAAE;AACTJ,UAAAA,MAAM,EAAG,KADA;AAETK,UAAAA,IAAI,EAAG,WAFE;AAGT;AACAxD,UAAAA,IAAI,EAAE,IAAIyD,MAAJ,CACH,iDAAgD7K,iBAAiB,CAAC8B,IAAlB,CAC9C,GAD8C,CAE/C,UAHE,CAJG;AASTgJ,UAAAA,QAAQ,EAAE,EATD;AAUT;AACAC,UAAAA,OAAO,EAAE;AAXA,SAHA;AAgBX;AACAK,QAAAA,GAAG,EAAE;AACHhE,UAAAA,IAAI,CAACnH,MAAD,EAAS;AACX,mBACE,CAACmK,WAAW,CAACnK,MAAD,CAAZ,IACAA,MAAM,CAACkL,IAAP,KAAgB,MADhB,IAEA,oBAAoB/D,IAApB,CAAyBnH,MAAM,CAACoL,UAAP,EAAzB,CAHF;AAKD,WAPE;;AAQHT,UAAAA,IAAI,CAAC3K,MAAD,EAAS;AACX,kBAAMqL,IAAI,GAAGnM,MAAM,CAACoM,UAAP,CAAmB,MAAnB,CAAb;;AACA,gBAAI,CAACtL,MAAM,CAACuL,QAAZ,EAAsB;AACpB,oBAAM,IAAI9G,KAAJ,CACH,oCAAmCzE,MAAM,CAACwH,IAAK,yBAD5C,CAAN;AAGD;;AAED6D,YAAAA,IAAI,CAACG,MAAL,CAAYxL,MAAM,CAACuL,QAAP,CAAgB;AAAEhC,cAAAA,OAAO,EAAErJ,OAAO,CAACC;AAAnB,aAAhB,CAAZ;AAEA,mBAAOkL,IAAI,CAACI,MAAL,CAAa,KAAb,EAAmBC,SAAnB,CAA6B,CAA7B,EAAgC,CAAhC,CAAP;AACD,WAnBE;;AAoBHb,UAAAA,QAAQ,EAAE,EApBP;AAqBHc,UAAAA,SAAS,EAAE,CArBR;AAsBHC,UAAAA,kBAAkB,EAAE;AAtBjB,SAjBM;AAyCXjH,QAAAA,OAAO,EAAE;AACPgG,UAAAA,IAAI,EAAG,SADA;AAEP;AACAgB,UAAAA,SAAS,EAAEE,IAAI,CAACC,GAAL,CAASb,eAAT,EAA0B,CAA1B,CAHJ;AAIPJ,UAAAA,QAAQ,EAAE;AAJH,SAzCE;AA+CX;AACAkB,QAAAA,MAAM,EAAE;AACN5E,UAAAA,IAAI,CAACnH,MAAD,EAAS;AACX,mBAAO,CAACmK,WAAW,CAACnK,MAAD,CAAnB;AACD,WAHK;;AAIN2K,UAAAA,IAAI,CAAC3K,MAAD,EAASsK,MAAT,EAAiB;AACnB,kBAAMe,IAAI,GAAGnM,MAAM,CAChBoM,UADU,CACE,MADF,EAEVE,MAFU,CAEHlB,MAAM,CAAC7H,MAAP,CAAc,CAACC,GAAD,EAAMsJ,KAAN,KAAgBtJ,GAAG,GAAGsJ,KAAK,CAACrB,IAA1C,EAAiD,EAAjD,CAFG,EAGVc,MAHU,CAGF,KAHE,CAAb;AAKA,mBAAOJ,IAAP;AACD,WAXK;;AAYNR,UAAAA,QAAQ,EAAE,EAZJ;AAaNc,UAAAA,SAAS,EAAE,CAbL;AAcNC,UAAAA,kBAAkB,EAAE;AAdd,SAhDG;AAiEX;AACA;AACAb,QAAAA,MAAM,EAAE;AACN5D,UAAAA,IAAI,CAACnH,MAAD,EAAS;AACX,mBAAOmK,WAAW,CAACnK,MAAD,CAAlB;AACD,WAHK;;AAKN2K,UAAAA,IAAI,EAAG,QALD;AAMNE,UAAAA,QAAQ,EAAE,EANJ;AAONC,UAAAA,OAAO,EAAE;AAPH;AAnEG,OAFK;AA+ElB;AACA;AACA;AACA;AACAmB,MAAAA,gBAAgB,EAAEC,QAnFA;AAoFlBC,MAAAA,kBAAkB,EAAE,EApFF;AAqFlBC,MAAAA,OAAO,EAAE;AArFS,KAApB;AAwFAhL,IAAAA,MAAM,CAACgJ,YAAP,GAAsB;AACpBiC,MAAAA,YAAY,EAAE;AACZ1B,QAAAA,IAAI,EAAG;AADK,OADM;AAIpBN,MAAAA,WAJoB;AAKpBiC,MAAAA,SAAS,EAAE,CACT;AACA,OAACpM,OAAO,CAACqM,QAAT,IACEvL,OAAO,CAACwL,QAAR,CACEtM,OAAO,CAAC6I,OAAR,GACI;AACE0D,QAAAA,aAAa,EAAE;AACbC,UAAAA,eAAe,EAAE,IADJ;AAEbC,UAAAA,WAAW,EAAE;AAFA;AADjB,OADJ,GAOI,EARN,CAHO,EAaT3L,OAAO,CAAC4L,SAAR,EAbS,EAcTtG,MAdS,CAcFC,OAdE;AALS,KAAtB;AAqBD;;AAED,MACE1F,KAAK,KAAM,YAAX,IACAA,KAAK,KAAM,cADX,IAEAA,KAAK,KAAM,WAHb,EAIE;AACA;AACA,UAAMgM,4BAA4B,GAChChM,KAAK,KAAM,cAAX,IACA,EAAE,OAA2B,GAA3B,IAAiC,4CAAnC,CAFF,CAFA,CAMA;;AACA,UAAMiM,mBAAmB,GACvBjM,KAAK,KAAM,YAAX,IACA,EAAE,OAA2B,GAA3B,IAAiC,4CAAnC,CAFF,CAPA,CAWA;AACA;;AACAO,IAAAA,MAAM,CAAC2L,gBAAP,GAA0B;AACxB;AACAC,MAAAA,IAAI,EAAE,CAACF;AAFiB,KAA1B;AAIA1L,IAAAA,MAAM,CAAC6L,SAAP,GAAmB,EAAnB;;AAEA,QAAIJ,4BAAJ,EAAkC;AAChC;AACA;AACA;AAEA;AACA,YAAMK,gBAAgB,GAAG,CAAE,OAAF,EAAU,cAAV,CAAzB;;AAEA,YAAMC,SAAS,GAAG,CAACC,IAAD,EAAOC,OAAP,KAAmB;AACnC,YAAI,OAAOD,IAAP,KAAiB,QAAjB,IAA4BA,IAAI,KAAKC,OAAzC,EAAkD;AAChD,iBAAO,IAAP;AACD,SAFD,MAEO,IAAID,IAAI,YAAYxC,MAAhB,IAA0BwC,IAAI,CAACjG,IAAL,CAAUkG,OAAV,CAA9B,EAAkD;AACvD,iBAAO,IAAP;AACD;;AAED,eAAO,KAAP;AACD,OARD;;AAUAjM,MAAAA,MAAM,CAAC6L,SAAP,CAAiBzG,IAAjB,CAAsB,UACpB;AAAE+C,QAAAA,OAAF;AAAWd,QAAAA,UAAX;AAAuB4E,QAAAA;AAAvB,OADoB,EAEpBC,QAFoB,EAGpB;AACA;AACA;AACA;AACA,cAAMC,QAAQ,GAAG9E,UAAU,CAAC;AAC1B+E,UAAAA,cAAc,EAAG;AADS,SAAD,CAA3B,CAJA,CAQA;;AACA,YAAIN,gBAAgB,CAACO,IAAjB,CAAsBL,IAAI,IAAID,SAAS,CAACC,IAAD,EAAOC,OAAP,CAAvC,CAAJ,EAA6D;AAC3D;AAEAE,UAAAA,QAAQ,CAAChE,OAAD,EAAU8D,OAAV,EAAmB,CAAClL,GAAD,EAAMuL,UAAN,KAAqB;AAC9C,gBAAIvL,GAAJ,EAAS;AACPmL,cAAAA,QAAQ,CAACnL,GAAD,CAAR;AACA;AACD;;AAEDmL,YAAAA,QAAQ,CAAC,IAAD,EAAOI,UAAP,CAAR;AACD,WAPO,CAAR;AAQA;AACD,SArBD,CAsBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;;AAEAJ,QAAAA,QAAQ;AACT,OAxCD;AAyCD;;AAED,QAAIR,mBAAJ,EAAyB;AACvB,UAAIjM,KAAK,KAAM,YAAf,EAA4B;AAC1B,cAAM8M,qBAAqB,GAAG,CAC3B,IAD2B,EAE3B,MAF2B,EAG3B,OAH2B,EAI3B,OAJ2B,EAK3B,eAL2B,CAA9B;;AAOA,cAAMC,2BAA2B,GAAGC,uBAAepL,MAAf,CAClC,CAACC,GAAD,EAAMoL,aAAN,KAAwB;AACtB,cAAIH,qBAAqB,CAACI,QAAtB,CAA+BD,aAA/B,CAAJ,EAAmD;AACjDpL,YAAAA,GAAG,CAACoL,aAAD,CAAH,GAAsB,YAAW1O,IAAI,CAACyC,IAAL,CAC/B3B,OAAO,CAACC,SADuB,EAE9B,QAF8B,EAG9B,sBAH8B,EAI/B2N,aAJ+B,CAK/B,EALF;AAMD,WAPD,MAOO;AACLpL,YAAAA,GAAG,CAACoL,aAAD,CAAH,GAAsB,YAAWA,aAAc,EAA/C;AACD;;AACD,iBAAOpL,GAAP;AACD,SAbiC,EAclC,EAdkC,CAApC;;AAiBAtB,QAAAA,MAAM,CAAC6L,SAAP,CAAiBe,OAAjB,CAAyBJ,2BAAzB;AACD;AACF;AACF;;AAED,MAAI/M,KAAK,KAAM,SAAf,EAAyB;AACvBO,IAAAA,MAAM,CAAC6L,SAAP,GAAmB;AACjB,0BAAqB;AADJ,KAAnB;AAGD;;AAED,MACEpM,KAAK,KAAM,kBAAX,IACAA,KAAK,KAAM,YADX,IAEAA,KAAK,KAAM,WAFX,IAGCH,OAAO,CAACC,GAAR,CAAYsN,qCAAZ,KACEpN,KAAK,KAAM,SAAX,IAAuBA,KAAK,KAAM,cADpC,CAJH,EAME;AACA,UAAMqN,aAAa,GAAG9O,IAAI,CAACyC,IAAL,CACpB3B,OAAO,CAACC,SADY,EAEnB,QAFmB,EAGnB,SAHmB,EAInB,QAAD,GAAWU,KAJS,CAAtB;AAOA,UAAMsN,WAAW,GAAG;AAClB3G,MAAAA,IAAI,EAAG,YADW;AAElBmD,MAAAA,IAAI,EAAE9J,KAFY;AAGlBqN,MAAAA,aAHkB;AAIlBE,MAAAA,iBAAiB,EAAE;AACjBhN,QAAAA,MAAM,EAAE,CACNiN,UADM,EAEN,GAAG7O,KAAK,CACL2B,QADA,GAEAmN,gBAFA,CAEiBhI,MAFjB,CAEwBiI,MAAM,IAC7BA,MAAM,CAACC,QAAP,CAAgBT,QAAhB,CAA0B,uBAA1B,CAHD,EAKAU,GALA,CAKIF,MAAM,IAAInP,IAAI,CAACyC,IAAL,CAAU0M,MAAM,CAACrK,OAAjB,EAA2B,gBAA3B,CALd,CAFG;AADS;AAJD,KAApB;AAiBA9C,IAAAA,MAAM,CAACsN,KAAP,GAAeP,WAAf;AACD;;AAED3O,EAAAA,KAAK,CAACmP,QAAN,CAAelP,OAAO,CAACmP,oBAAR,CAA6BxN,MAA7B,CAAf;;AACA,QAAMyN,SAAS,GAAG,MAAMrP,KAAK,CAAC2B,QAAN,GAAiB2N,OAAzC;;AAEA,QAAMjP,aAAa,CAAE,uBAAF,EAA0B;AAC3CgP,IAAAA,SAD2C;AAE3C;AACAhO,IAAAA,KAAK,EAAEA,KAAK,KAAM,WAAX,GAAyB,YAAzB,GAAuCA,KAHH;AAI3CC,IAAAA,KAJ2C;AAK3CC,IAAAA,OAL2C;AAM3CC,IAAAA,OAN2C;AAO3CV,IAAAA;AAP2C,GAA1B,CAAnB;;AAUA,MAAIC,iBAAJ,EAAuB;AACrB;AACA;AACA;AACA;AACA,UAAMwO,mBAAmB,GAAG,EAA5B;;AACA,UAAMC,cAAc,GAAGhQ,OAAO,CAACkF,OAAR,CAAiB,gBAAjB,CAAvB;;AACA,SAAK,MAAM+K,IAAX,IAAmBJ,SAAS,GAAG7O,MAAZ,CAAmBc,KAAtC,EAA6C;AAAA;;AAC3C,UAAI,CAACmO,IAAI,CAAClH,GAAN,IAAa,CAACkH,IAAI,CAACjH,MAAvB,EAA+B;AAC7B;AACD;;AAED,YAAMkH,WAAW,GAAGC,KAAK,CAACC,OAAN,CAAcH,IAAI,CAAClH,GAAnB,IAChBkH,IAAI,CAAClH,GAAL,CAAS0G,GAAT,CAAaY,QAAQ,IACnB,OAAOA,QAAP,KAAqB,QAArB,GAA+BA,QAA/B,GAA0CA,QAAQ,CAACrH,MADrD,CADgB,GAIhB,kCAACiH,IAAI,CAAClH,GAAN,8CAAC,UAAUC,MAAX,+DAAqBiH,IAAI,CAACjH,MAA1B,CAJJ;AAMA,YAAMsH,cAAc,GAAGJ,WAAW,CAACzB,IAAZ,CACrBzF,MAAM,IAAIA,MAAM,KAAKgH,cADA,CAAvB;;AAIA,UAAIM,cAAJ,EAAoB;AAClBP,QAAAA,mBAAmB,CAACvI,IAApB,CAAyByI,IAAI,CAAC9H,IAA9B;AACD;AACF,KAzBoB,CA2BrB;;;AACA,UAAMoI,YAAY,GAAG,oBAArB;;AACAA,IAAAA,YAAY,CAACpI,IAAb,GAAoBqI,UAAU,IAAI;AAChC;AACA;AACA,YAAMC,oBAAoB,GAAGD,UAAU,CAACE,OAAX,CAAoB,GAApB,CAA7B;;AACA,UAAID,oBAAoB,KAAK,CAAC,CAA9B,EAAiC;AAC/BD,QAAAA,UAAU,GAAGA,UAAU,CAAC5L,MAAX,CAAkB,CAAlB,EAAqB6L,oBAArB,CAAb;AACD;;AAED,aAAOV,mBAAmB,CAACtB,IAApB,CAAyBkC,EAAE,IAAIA,EAAE,CAACxI,IAAH,CAAQqI,UAAR,CAA/B,CAAP;AACD,KATD;;AAWAjP,IAAAA,iBAAiB,CAACqP,OAAlB,CAA0BC,OAA1B,GAAoCN,YAApC;AACD;;AAED,SAAOV,SAAS,EAAhB;AACD,CAv4BD","sourcesContent":["require(`v8-compile-cache`)\n\nconst { isCI } = require(`gatsby-core-utils`)\nconst crypto = require(`crypto`)\nconst fs = require(`fs-extra`)\nconst path = require(`path`)\nconst dotenv = require(`dotenv`)\nconst { CoreJSResolver } = require(`./webpack/corejs-resolver`)\nconst { CacheFolderResolver } = require(`./webpack/cache-folder-resolver`)\nconst { store } = require(`../redux`)\nconst { actions } = require(`../redux/actions`)\nconst { getPublicPath } = require(`./get-public-path`)\nconst debug = require(`debug`)(`gatsby:webpack-config`)\nconst report = require(`gatsby-cli/lib/reporter`)\nimport { withBasePath, withTrailingSlash } from \"./path\"\nimport { getGatsbyDependents } from \"./gatsby-dependents\"\nconst apiRunnerNode = require(`./api-runner-node`)\nimport { createWebpackUtils } from \"./webpack-utils\"\nimport { hasLocalEslint } from \"./local-eslint-config-finder\"\nimport { getAbsolutePathForVirtualModule } from \"./gatsby-webpack-virtual-modules\"\nimport { StaticQueryMapper } from \"./webpack/static-query-mapper\"\nimport { ForceCssHMRForEdgeCases } from \"./webpack/force-css-hmr-for-edge-cases\"\nimport { hasES6ModuleSupport } from \"./browserslist\"\nimport { builtinModules } from \"module\"\nimport { shouldGenerateEngines } from \"./engines-helpers\"\nimport { ROUTES_DIRECTORY } from \"../constants\"\nconst { BabelConfigItemsCacheInvalidatorPlugin } = require(`./babel-loader`)\n\nconst FRAMEWORK_BUNDLES = [`react`, `react-dom`, `scheduler`, `prop-types`]\n\n// Four stages or modes:\n//   1) develop: for `gatsby develop` command, hot reload and CSS injection into page\n//   2) develop-html: same as develop without react-hmre in the babel config for html renderer\n//   3) build-javascript: Build JS and CSS chunks for production\n//   4) build-html: build all HTML files\n\nmodule.exports = async (\n  program,\n  directory,\n  suppliedStage,\n  port,\n  { parentSpan } = {}\n) => {\n  let fastRefreshPlugin\n  const modulesThatUseGatsby = await getGatsbyDependents()\n  const directoryPath = withBasePath(directory)\n\n  // we will converge to build-html later on but for now this was the fastest way to get SSR to work\n  // TODO remove in v4 - we deprecated this in v3\n  process.env.GATSBY_BUILD_STAGE =\n    suppliedStage === `build-ssr` ? `build-html` : suppliedStage\n\n  // We combine develop & develop-html stages for purposes of generating the\n  // webpack config.\n  const stage = suppliedStage\n  const { rules, loaders, plugins } = createWebpackUtils(\n    suppliedStage === `build-ssr` ? `build-html` : stage,\n    program\n  )\n\n  const { assetPrefix, pathPrefix } = store.getState().config\n\n  const publicPath = getPublicPath({ assetPrefix, pathPrefix, ...program })\n\n  function processEnv(stage, defaultNodeEnv) {\n    debug(`Building env for \"${stage}\"`)\n    // node env should be DEVELOPMENT | PRODUCTION as these are commonly used in node land\n    // this variable is used inside webpack\n    const nodeEnv = process.env.NODE_ENV || `${defaultNodeEnv}`\n    // config env is dependent on the env that it's run, this can be anything from staging-production\n    // this allows you to set use different .env environments or conditions in gatsby files\n    const configEnv = process.env.GATSBY_ACTIVE_ENV || nodeEnv\n    const envFile = path.join(process.cwd(), `./.env.${configEnv}`)\n    let parsed = {}\n    try {\n      parsed = dotenv.parse(fs.readFileSync(envFile, { encoding: `utf8` }))\n    } catch (err) {\n      if (err.code !== `ENOENT`) {\n        report.error(\n          `There was a problem processing the .env file (${envFile})`,\n          err\n        )\n      }\n    }\n\n    const envObject = Object.keys(parsed).reduce((acc, key) => {\n      acc[key] = JSON.stringify(parsed[key])\n      return acc\n    }, {})\n\n    const gatsbyVarObject = Object.keys(process.env).reduce((acc, key) => {\n      if (key.match(/^GATSBY_/)) {\n        acc[key] = JSON.stringify(process.env[key])\n      }\n      return acc\n    }, {})\n\n    // Don't allow overwriting of NODE_ENV, PUBLIC_DIR as to not break gatsby things\n    envObject.NODE_ENV = JSON.stringify(nodeEnv)\n    envObject.PUBLIC_DIR = JSON.stringify(`${process.cwd()}/public`)\n    envObject.BUILD_STAGE = JSON.stringify(\n      stage === `build-ssr` ? `build-html` : stage\n    )\n    envObject.CYPRESS_SUPPORT = JSON.stringify(process.env.CYPRESS_SUPPORT)\n    envObject.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND = JSON.stringify(\n      !!process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND\n    )\n\n    if (stage === `develop`) {\n      envObject.GATSBY_SOCKET_IO_DEFAULT_TRANSPORT = JSON.stringify(\n        process.env.GATSBY_SOCKET_IO_DEFAULT_TRANSPORT || `websocket`\n      )\n    }\n\n    const mergedEnvVars = Object.assign(envObject, gatsbyVarObject)\n\n    return Object.keys(mergedEnvVars).reduce(\n      (acc, key) => {\n        acc[`process.env.${key}`] = mergedEnvVars[key]\n        return acc\n      },\n      {\n        \"process.env\": `({})`,\n      }\n    )\n  }\n\n  function getHmrPath() {\n    // ref: https://github.com/gatsbyjs/gatsby/issues/8348\n    let hmrBasePath = `/`\n    const hmrSuffix = `__webpack_hmr&reload=true&overlay=false`\n\n    if (process.env.GATSBY_WEBPACK_PUBLICPATH) {\n      const pubPath = process.env.GATSBY_WEBPACK_PUBLICPATH\n      if (pubPath.substr(-1) === `/`) {\n        hmrBasePath = pubPath\n      } else {\n        hmrBasePath = withTrailingSlash(pubPath)\n      }\n    }\n\n    return hmrBasePath + hmrSuffix\n  }\n\n  debug(`Loading webpack config for stage \"${stage}\"`)\n  function getOutput() {\n    switch (stage) {\n      case `develop`:\n        return {\n          path: directory,\n          filename: `[name].js`,\n          // Add /* filename */ comments to generated require()s in the output.\n          pathinfo: true,\n          // Point sourcemap entries to original disk location (format as URL on Windows)\n          publicPath: process.env.GATSBY_WEBPACK_PUBLICPATH || `/`,\n          devtoolModuleFilenameTemplate: info =>\n            path.resolve(info.absoluteResourcePath).replace(/\\\\/g, `/`),\n          // Avoid React cross-origin errors\n          // See https://reactjs.org/docs/cross-origin-errors.html\n          crossOriginLoading: `anonymous`,\n        }\n      case `build-html`:\n      case `develop-html`:\n        // Generate the file needed to SSR pages.\n        // Deleted by build-html.js, since it's not needed for production.\n        return {\n          path: directoryPath(`public`),\n          filename: `render-page.js`,\n          libraryTarget: `commonjs`,\n          publicPath: withTrailingSlash(publicPath),\n        }\n      case `build-javascript`:\n        return {\n          filename: `[name]-[contenthash].js`,\n          chunkFilename: `[name]-[contenthash].js`,\n          path: directoryPath(`public`),\n          publicPath: withTrailingSlash(publicPath),\n        }\n      case `build-ssr`: {\n        return {\n          path: directoryPath(ROUTES_DIRECTORY),\n          filename: `[name].js`,\n          libraryTarget: `commonjs2`,\n        }\n      }\n      default:\n        throw new Error(`The state requested ${stage} doesn't exist.`)\n    }\n  }\n\n  function getEntry() {\n    switch (stage) {\n      case `develop`:\n        return hasES6ModuleSupport(directory)\n          ? {\n              commons: [directoryPath(`.cache/app`)],\n            }\n          : {\n              polyfill: directoryPath(`.cache/polyfill-entry`),\n              commons: [directoryPath(`.cache/app`)],\n            }\n      case `develop-html`:\n        return {\n          main: process.env.GATSBY_EXPERIMENTAL_DEV_SSR\n            ? directoryPath(`.cache/ssr-develop-static-entry`)\n            : directoryPath(`.cache/develop-static-entry`),\n        }\n      case `build-ssr`: {\n        const entries = Object.create(null)\n        for (const [, { componentPath, componentChunkName }] of store.getState()\n          .components) {\n          entries[componentChunkName] = componentPath\n        }\n\n        return entries\n      }\n      case `build-html`:\n        return {\n          main: directoryPath(`.cache/static-entry`),\n        }\n      case `build-javascript`:\n        return hasES6ModuleSupport(directory)\n          ? {\n              app: directoryPath(`.cache/production-app`),\n            }\n          : {\n              polyfill: directoryPath(`.cache/polyfill-entry`),\n              app: directoryPath(`.cache/production-app`),\n            }\n      default:\n        throw new Error(`The state requested ${stage} doesn't exist.`)\n    }\n  }\n\n  function getPlugins() {\n    let configPlugins = [\n      plugins.moment(),\n\n      // Add a few global variables. Set NODE_ENV to production (enables\n      // optimizations for React) and what the link prefix is (__PATH_PREFIX__).\n      plugins.define({\n        ...processEnv(stage, `development`),\n        __BASE_PATH__: JSON.stringify(program.prefixPaths ? pathPrefix : ``),\n        __PATH_PREFIX__: JSON.stringify(program.prefixPaths ? publicPath : ``),\n        __ASSET_PREFIX__: JSON.stringify(\n          program.prefixPaths ? assetPrefix : ``\n        ),\n        // TODO Improve asset passing to pages\n        BROWSER_ESM_ONLY: JSON.stringify(hasES6ModuleSupport(directory)),\n      }),\n\n      plugins.virtualModules(),\n      new BabelConfigItemsCacheInvalidatorPlugin(),\n    ]\n\n    switch (stage) {\n      case `develop`: {\n        configPlugins = configPlugins\n          .concat([\n            (fastRefreshPlugin = plugins.fastRefresh({ modulesThatUseGatsby })),\n            new ForceCssHMRForEdgeCases(),\n            plugins.hotModuleReplacement(),\n            plugins.noEmitOnErrors(),\n            plugins.eslintGraphqlSchemaReload(),\n            new StaticQueryMapper(store),\n          ])\n          .filter(Boolean)\n\n        configPlugins.push(\n          plugins.extractText({\n            filename: `[name].css`,\n            chunkFilename: `[id].css`,\n          })\n        )\n\n        if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n          configPlugins.push(plugins.extractStats())\n        }\n\n        const isCustomEslint = hasLocalEslint(program.directory)\n        // get schema to pass to eslint config and program for directory\n        const { schema } = store.getState()\n\n        // if no local eslint config, then add gatsby config\n        if (!isCustomEslint) {\n          configPlugins.push(plugins.eslint(schema))\n        }\n\n        // Enforce fast-refresh rules even with local eslint config\n        if (isCustomEslint) {\n          configPlugins.push(plugins.eslintRequired())\n        }\n\n        break\n      }\n      case `build-javascript`: {\n        configPlugins = configPlugins.concat([\n          plugins.extractText({\n            filename: `[name].[contenthash].css`,\n            chunkFilename: `[name].[contenthash].css`,\n          }),\n          // Write out stats object mapping named dynamic imports (aka page\n          // components) to all their async chunks.\n          plugins.extractStats(),\n          new StaticQueryMapper(store),\n        ])\n        break\n      }\n    }\n\n    return configPlugins\n  }\n\n  function getDevtool() {\n    switch (stage) {\n      case `develop`:\n        return `eval-cheap-module-source-map`\n      // use a normal `source-map` for the html phases since\n      // it gives better line and column numbers\n      case `develop-html`:\n      case `build-html`:\n      case `build-ssr`:\n      case `build-javascript`:\n        return `source-map`\n      default:\n        return false\n    }\n  }\n\n  function getMode() {\n    switch (stage) {\n      case `develop`:\n      case `develop-html`:\n        return `development`\n      case `build-javascript`:\n      case `build-html`:\n        return `production`\n      default:\n        return `production`\n    }\n  }\n\n  function getModule() {\n    // Common config for every env.\n    // prettier-ignore\n    let configRules = [\n      // Webpack expects extensions when importing ESM modules as that's what the spec describes.\n      // Not all libraries have adapted so we don't enforce its behaviour\n      // @see https://github.com/webpack/webpack/issues/11467\n      {\n        test: /\\.mjs$/i,\n        resolve: {\n          byDependency: {\n            esm: {\n              fullySpecified: false\n            }\n          }\n        }\n      },\n      {\n        test: /\\.js$/i,\n        descriptionData: {\n          type: `module`\n        },\n        resolve: {\n          byDependency: {\n            esm: {\n              fullySpecified: false\n            }\n          }\n        }\n      },\n      rules.js({\n        modulesThatUseGatsby,\n      }),\n      rules.yaml(),\n      rules.fonts(),\n      rules.images(),\n      rules.media(),\n      rules.miscAssets(),\n\n      // This is a hack that exports one of @reach/router internals (BaseContext)\n      // to export list. We need it to reset basepath and baseuri context after\n      // Gatsby main router changes it, to keep v2 behaviour.\n      // We will need to most likely remove this for v3.\n      {\n        test: require.resolve(`@gatsbyjs/reach-router/es/index`),\n        type: `javascript/auto`,\n        use: [{\n          loader: require.resolve(`./reach-router-add-basecontext-export-loader`),\n        }],\n      }\n    ]\n\n    // Speedup ðŸŽï¸ðŸ’¨ the build! We only include transpilation of node_modules on javascript production builds\n    // TODO create gatsby plugin to enable this behaviour on develop (only when people are requesting this feature)\n    if (stage === `build-javascript`) {\n      configRules.push(\n        rules.dependencies({\n          modulesThatUseGatsby,\n        })\n      )\n    }\n\n    switch (stage) {\n      case `develop`: {\n        configRules = configRules.concat([\n          {\n            oneOf: [rules.cssModules(), rules.css()],\n          },\n        ])\n\n        break\n      }\n      case `build-html`:\n      case `develop-html`:\n      case `build-ssr`:\n        // We don't deal with CSS at all when building the HTML.\n        // The 'null' loader is used to prevent 'module not found' errors.\n        // On the other hand CSS modules loaders are necessary.\n\n        // prettier-ignore\n        configRules = configRules.concat([\n          {\n            oneOf: [\n              rules.cssModules(),\n              {\n                ...rules.css(),\n                use: [loaders.null()],\n              },\n            ],\n          },\n        ])\n        break\n\n      case `build-javascript`:\n        // We don't deal with CSS at all when building JavaScript but we still\n        // need to process the CSS so offline-plugin knows about the various\n        // assets referenced in your CSS.\n        //\n        // It's also necessary to process CSS Modules so your JS knows the\n        // classNames to use.\n        configRules = configRules.concat([\n          {\n            oneOf: [rules.cssModules(), rules.css()],\n          },\n        ])\n\n        break\n    }\n\n    return { rules: configRules }\n  }\n\n  function getPackageRoot(pkg) {\n    return path.dirname(require.resolve(`${pkg}/package.json`))\n  }\n\n  function getResolve(stage) {\n    const { program } = store.getState()\n    const resolve = {\n      // Use the program's extension list (generated via the\n      // 'resolvableExtensions' API hook).\n      extensions: [...program.extensions],\n      alias: {\n        gatsby$: directoryPath(path.join(`.cache`, `gatsby-browser-entry.js`)),\n        // Using directories for module resolution is mandatory because\n        // relative path imports are used sometimes\n        // See https://stackoverflow.com/a/49455609/6420957 for more details\n        \"@babel/runtime\": getPackageRoot(`@babel/runtime`),\n        \"@reach/router\": getPackageRoot(`@gatsbyjs/reach-router`),\n        \"react-lifecycles-compat\": directoryPath(\n          `.cache/react-lifecycles-compat.js`\n        ),\n        \"@pmmmwh/react-refresh-webpack-plugin\": getPackageRoot(\n          `@pmmmwh/react-refresh-webpack-plugin`\n        ),\n        \"socket.io-client\": getPackageRoot(`socket.io-client`),\n        \"webpack-hot-middleware\": getPackageRoot(\n          `@gatsbyjs/webpack-hot-middleware`\n        ),\n        $virtual: getAbsolutePathForVirtualModule(`$virtual`),\n      },\n      plugins: [\n        new CoreJSResolver(),\n        new CacheFolderResolver(path.join(program.directory, `.cache`)),\n      ],\n    }\n\n    const target =\n      stage === `build-html` ||\n      stage === `develop-html` ||\n      stage === `build-ssr`\n        ? `node`\n        : `web`\n    if (target === `web`) {\n      resolve.alias[`@reach/router`] = path.join(\n        getPackageRoot(`@gatsbyjs/reach-router`),\n        `es`\n      )\n    }\n\n    if (stage === `build-javascript` && program.profile) {\n      resolve.alias[`react-dom$`] = `react-dom/profiling`\n      resolve.alias[`scheduler/tracing`] = `scheduler/tracing-profiling`\n    }\n\n    // SSR can have many react versions as some packages use their own version. React works best with 1 version.\n    // By resolving react,react-dom from gatsby we'll get the site versions of react & react-dom because it's specified as a peerdependency.\n    //\n    // we need to put this below our resolve.alias for profiling as webpack picks the first one that matches\n    // @see https://github.com/gatsbyjs/gatsby/issues/31098\n    resolve.alias[`react`] = getPackageRoot(`react`)\n    resolve.alias[`react-dom`] = getPackageRoot(`react-dom`)\n\n    return resolve\n  }\n\n  function getResolveLoader() {\n    const root = [path.resolve(directory, `node_modules`)]\n\n    const userLoaderDirectoryPath = path.resolve(directory, `loaders`)\n\n    try {\n      if (fs.statSync(userLoaderDirectoryPath).isDirectory()) {\n        root.push(userLoaderDirectoryPath)\n      }\n    } catch (err) {\n      debug(`Error resolving user loaders directory`, err)\n    }\n\n    return {\n      modules: [...root, path.join(__dirname, `../loaders`), `node_modules`],\n    }\n  }\n\n  const config = {\n    // Context is the base directory for resolving the entry option.\n    context: directory,\n    entry: getEntry(),\n    output: getOutput(),\n\n    module: getModule(),\n    plugins: getPlugins(),\n\n    devtool: getDevtool(),\n    // Turn off performance hints as we (for now) don't want to show the normal\n    // webpack output anywhere.\n    performance: {\n      hints: false,\n    },\n    mode: getMode(),\n\n    resolveLoader: getResolveLoader(),\n    resolve: getResolve(stage),\n  }\n\n  if (\n    stage === `build-html` ||\n    stage === `develop-html` ||\n    stage === `build-ssr`\n  ) {\n    const [major, minor] = process.version.replace(`v`, ``).split(`.`)\n    config.target = `node12.13`\n  } else {\n    config.target = [`web`, `es5`]\n  }\n\n  const isCssModule = module => module.type === `css/mini-extract`\n\n  if (stage === `develop`) {\n    config.optimization = {\n      splitChunks: {\n        chunks: `all`,\n        cacheGroups: {\n          default: false,\n          defaultVendors: false,\n          framework: {\n            chunks: `all`,\n            name: `framework`,\n            // This regex ignores nested copies of framework libraries so they're bundled with their issuer.\n            test: new RegExp(\n              `(?<!node_modules.*)[\\\\\\\\/]node_modules[\\\\\\\\/](${FRAMEWORK_BUNDLES.join(\n                `|`\n              )})[\\\\\\\\/]`\n            ),\n            priority: 40,\n            // Don't let webpack eliminate this chunk (prevents this chunk from becoming a part of the commons chunk)\n            enforce: true,\n          },\n          // Bundle all css & lazy css into one stylesheet to make sure lazy components do not break\n          // TODO make an exception for css-modules\n          styles: {\n            test(module) {\n              return isCssModule(module)\n            },\n\n            name: `commons`,\n            priority: 40,\n            enforce: true,\n          },\n        },\n      },\n      minimize: false,\n    }\n  }\n\n  if (stage === `build-html`) {\n    config.optimization = {\n      minimize: false,\n    }\n  }\n\n  if (stage === `build-javascript`) {\n    const componentsCount = store.getState().components.size\n\n    const splitChunks = {\n      chunks: `all`,\n      cacheGroups: {\n        default: false,\n        defaultVendors: false,\n        framework: {\n          chunks: `all`,\n          name: `framework`,\n          // This regex ignores nested copies of framework libraries so they're bundled with their issuer.\n          test: new RegExp(\n            `(?<!node_modules.*)[\\\\\\\\/]node_modules[\\\\\\\\/](${FRAMEWORK_BUNDLES.join(\n              `|`\n            )})[\\\\\\\\/]`\n          ),\n          priority: 40,\n          // Don't let webpack eliminate this chunk (prevents this chunk from becoming a part of the commons chunk)\n          enforce: true,\n        },\n        // if a module is bigger than 160kb from node_modules we make a separate chunk for it\n        lib: {\n          test(module) {\n            return (\n              !isCssModule(module) &&\n              module.size() > 160000 &&\n              /node_modules[/\\\\]/.test(module.identifier())\n            )\n          },\n          name(module) {\n            const hash = crypto.createHash(`sha1`)\n            if (!module.libIdent) {\n              throw new Error(\n                `Encountered unknown module type: ${module.type}. Please open an issue.`\n              )\n            }\n\n            hash.update(module.libIdent({ context: program.directory }))\n\n            return hash.digest(`hex`).substring(0, 8)\n          },\n          priority: 30,\n          minChunks: 1,\n          reuseExistingChunk: true,\n        },\n        commons: {\n          name: `commons`,\n          // if a chunk is used on all components we put it in commons (we need at least 2 components)\n          minChunks: Math.max(componentsCount, 2),\n          priority: 20,\n        },\n        // If a chunk is used in at least 2 components we create a separate chunk\n        shared: {\n          test(module) {\n            return !isCssModule(module)\n          },\n          name(module, chunks) {\n            const hash = crypto\n              .createHash(`sha1`)\n              .update(chunks.reduce((acc, chunk) => acc + chunk.name, ``))\n              .digest(`hex`)\n\n            return hash\n          },\n          priority: 10,\n          minChunks: 2,\n          reuseExistingChunk: true,\n        },\n\n        // Bundle all css & lazy css into one stylesheet to make sure lazy components do not break\n        // TODO make an exception for css-modules\n        styles: {\n          test(module) {\n            return isCssModule(module)\n          },\n\n          name: `styles`,\n          priority: 40,\n          enforce: true,\n        },\n      },\n      // We load our pages async through async-requires, maxInitialRequests doesn't have an effect on chunks derived from page components.\n      // By default webpack has set maxAsyncRequests to 6, in some cases this isn't enough an actually makes the bundle size blow up.\n      // We've set maxAsyncRequests to Infinity to negate this. This could potentionally exceed the 25 initial requests that we set before\n      // sadly I do not have a better solution.\n      maxAsyncRequests: Infinity,\n      maxInitialRequests: 25,\n      minSize: 20000,\n    }\n\n    config.optimization = {\n      runtimeChunk: {\n        name: `webpack-runtime`,\n      },\n      splitChunks,\n      minimizer: [\n        // TODO: maybe this option should be noMinimize?\n        !program.noUglify &&\n          plugins.minifyJs(\n            program.profile\n              ? {\n                  terserOptions: {\n                    keep_classnames: true,\n                    keep_fnames: true,\n                  },\n                }\n              : {}\n          ),\n        plugins.minifyCss(),\n      ].filter(Boolean),\n    }\n  }\n\n  if (\n    stage === `build-html` ||\n    stage === `develop-html` ||\n    stage === `build-ssr`\n  ) {\n    // externalize react, react-dom when develop-html or build-html(when not generating engines)\n    const shouldMarkPackagesAsExternal =\n      stage === `develop-html` ||\n      !(_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines())\n\n    // tracking = build-html (when not generating engines)\n    const shouldTrackBuiltins =\n      stage === `build-html` &&\n      !(_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines())\n\n    // removes node internals from bundle\n    // https://webpack.js.org/configuration/externals/#externalspresets\n    config.externalsPresets = {\n      // use it only when not tracking builtins (tracking builtins provide their own fallbacks)\n      node: !shouldTrackBuiltins,\n    }\n    config.externals = []\n\n    if (shouldMarkPackagesAsExternal) {\n      // Packages we want to externalize to save some build time\n      // https://github.com/gatsbyjs/gatsby/pull/14208#pullrequestreview-240178728\n      // const externalList = [`common-tags`, `lodash`, `semver`, /^lodash\\//]\n\n      // Packages we want to externalize because meant to be user-provided\n      const userExternalList = [`react`, /^react-dom\\//]\n\n      const checkItem = (item, request) => {\n        if (typeof item === `string` && item === request) {\n          return true\n        } else if (item instanceof RegExp && item.test(request)) {\n          return true\n        }\n\n        return false\n      }\n\n      config.externals.push(function (\n        { context, getResolve, request },\n        callback\n      ) {\n        // allows us to resolve webpack aliases from our config\n        // helpful for when react is aliased to preact-compat\n        // Force commonjs as we're in node land\n        const resolver = getResolve({\n          dependencyType: `commonjs`,\n        })\n\n        // User modules that do not need to be part of the bundle\n        if (userExternalList.some(item => checkItem(item, request))) {\n          // TODO figure out to make preact work with this too\n\n          resolver(context, request, (err, newRequest) => {\n            if (err) {\n              callback(err)\n              return\n            }\n\n            callback(null, newRequest)\n          })\n          return\n        }\n        // TODO look into re-enabling, breaks builds right now because of esm\n        // User modules that do not need to be part of the bundle\n        // if (externalList.some(item => checkItem(item, request))) {\n        //   resolver(context, request, (err, request) => {\n        //     if (err) {\n        //       callback(err)\n        //       return\n        //     }\n\n        //     callback(null, `commonjs2 ${request}`)\n        //   })\n        //   return\n        // }\n\n        callback()\n      })\n    }\n\n    if (shouldTrackBuiltins) {\n      if (stage === `build-html`) {\n        const builtinModulesToTrack = [\n          `fs`,\n          `http`,\n          `http2`,\n          `https`,\n          `child_process`,\n        ]\n        const builtinsExternalsDictionary = builtinModules.reduce(\n          (acc, builtinModule) => {\n            if (builtinModulesToTrack.includes(builtinModule)) {\n              acc[builtinModule] = `commonjs ${path.join(\n                program.directory,\n                `.cache`,\n                `ssr-builtin-trackers`,\n                builtinModule\n              )}`\n            } else {\n              acc[builtinModule] = `commonjs ${builtinModule}`\n            }\n            return acc\n          },\n          {}\n        )\n\n        config.externals.unshift(builtinsExternalsDictionary)\n      }\n    }\n  }\n\n  if (stage === `develop`) {\n    config.externals = {\n      \"socket.io-client\": `io`,\n    }\n  }\n\n  if (\n    stage === `build-javascript` ||\n    stage === `build-html` ||\n    stage === `build-ssr` ||\n    (process.env.GATSBY_EXPERIMENTAL_DEV_WEBPACK_CACHE &&\n      (stage === `develop` || stage === `develop-html`))\n  ) {\n    const cacheLocation = path.join(\n      program.directory,\n      `.cache`,\n      `webpack`,\n      `stage-` + stage\n    )\n\n    const cacheConfig = {\n      type: `filesystem`,\n      name: stage,\n      cacheLocation,\n      buildDependencies: {\n        config: [\n          __filename,\n          ...store\n            .getState()\n            .flattenedPlugins.filter(plugin =>\n              plugin.nodeAPIs.includes(`onCreateWebpackConfig`)\n            )\n            .map(plugin => path.join(plugin.resolve, `gatsby-node.js`)),\n        ],\n      },\n    }\n\n    config.cache = cacheConfig\n  }\n\n  store.dispatch(actions.replaceWebpackConfig(config))\n  const getConfig = () => store.getState().webpack\n\n  await apiRunnerNode(`onCreateWebpackConfig`, {\n    getConfig,\n    // we will converge to build-html later on but for now this was the fastest way to get SSR to work\n    stage: stage === `build-ssr` ? `build-html` : stage,\n    rules,\n    loaders,\n    plugins,\n    parentSpan,\n  })\n\n  if (fastRefreshPlugin) {\n    // Fast refresh plugin has `include` option that determines\n    // wether HMR code gets injected. We need to make sure all custom loaders\n    // (like .ts or .mdx) that use our babel-loader will be taken into account\n    // when deciding which modules get fast-refresh HMR addition.\n    const fastRefreshIncludes = []\n    const babelLoaderLoc = require.resolve(`./babel-loader`)\n    for (const rule of getConfig().module.rules) {\n      if (!rule.use && !rule.loader) {\n        continue\n      }\n\n      const ruleLoaders = Array.isArray(rule.use)\n        ? rule.use.map(useEntry =>\n            typeof useEntry === `string` ? useEntry : useEntry.loader\n          )\n        : [rule.use?.loader ?? rule.loader]\n\n      const hasBabelLoader = ruleLoaders.some(\n        loader => loader === babelLoaderLoc\n      )\n\n      if (hasBabelLoader) {\n        fastRefreshIncludes.push(rule.test)\n      }\n    }\n\n    // start with default include of fast refresh plugin\n    const includeRegex = /\\.([jt]sx?|flow)$/i\n    includeRegex.test = modulePath => {\n      // drop query param from request (i.e. ?type=component for mdx-loader)\n      // so loader rule test work well\n      const queryParamStartIndex = modulePath.indexOf(`?`)\n      if (queryParamStartIndex !== -1) {\n        modulePath = modulePath.substr(0, queryParamStartIndex)\n      }\n\n      return fastRefreshIncludes.some(re => re.test(modulePath))\n    }\n\n    fastRefreshPlugin.options.include = includeRegex\n  }\n\n  return getConfig()\n}\n"],"file":"webpack.config.js"}